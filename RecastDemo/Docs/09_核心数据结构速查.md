# 附录：核心数据结构速查

## 1. 构建阶段数据结构

### 1.1 rcSpan — 高度场体素跨度

```cpp
struct rcSpan {
    unsigned int smin : 13;   // 实体底部高度 (体素单位) [0, 8191]
    unsigned int smax : 13;   // 实体顶部高度 (体素单位) [0, 8191]
    unsigned int area : 6;    // 区域 ID [0, 63]
    rcSpan* next;             // 同列中下一个更高的 Span
};
```

```
Y轴   ┌──────┐
 ↑    │Span C│ smin=50, smax=60, area=0  → next=NULL
 │    └──────┘
 │    (开放空间 40~50)
 │    ┌──────┐
 │    │Span B│ smin=30, smax=40, area=63 → next=C
 │    └──────┘
 │    (开放空间 20~30)
 │    ┌──────┐
 │    │Span A│ smin=0, smax=20, area=63  → next=B
 │    └──────┘
```

**Area 常见值**：
- `RC_NULL_AREA (0)` — 不可行走
- `RC_WALKABLE_AREA (63)` — 可行走（默认）
- `1~62` — 用户自定义区域

---

### 1.2 rcHeightfield — 稀疏高度场

```cpp
struct rcHeightfield {
    int width;              // X 轴网格数
    int height;             // Z 轴网格数
    float bmin[3];          // 包围盒最小角 (世界坐标)
    float bmax[3];          // 包围盒最大角 (世界坐标)
    float cs;               // XZ 体素尺寸 (世界单位)
    float ch;               // Y 体素高度 (世界单位)
    rcSpan** spans;         // Span 链表指针数组 [width * height]
    rcSpanPool* pools;      // 内存池链表
    rcSpan* freelist;       // 空闲 Span 链表
};
```

```
访问方式: spans[x + z * width] → 该列的 Span 链表头
坐标转换: voxelX = (worldX - bmin[0]) / cs
          voxelY = (worldY - bmin[1]) / ch
```

**生命周期**：Step 2 创建 → Step 3 过滤 → Step 4 转换后可释放

---

### 1.3 rcCompactCell — 紧凑高度场的列描述

```cpp
struct rcCompactCell {
    unsigned int index : 24;  // 该列第一个 Span 在 spans[] 中的索引
    unsigned int count : 8;   // 该列中 Span 的数量 (最多 255)
};
```

---

### 1.4 rcCompactSpan — 紧凑高度场的跨度

```cpp
struct rcCompactSpan {
    unsigned short y;        // 开放空间底面高度 (= 原 rcSpan.smax)
    unsigned short reg;      // 所属区域 ID (rcBuildRegions 填充)
    unsigned int con : 24;   // 四方向邻居连接信息
    unsigned int h : 8;      // 开放空间高度 (最大 255)
};
```

```
con 字段 (24 位):
  ┌──────┬──────┬──────┬──────┐
  │ 方向0 │ 方向1 │ 方向2 │ 方向3 │  各 6 位
  │  -X   │  +Z   │  +X   │  -Z   │
  └──────┴──────┴──────┴──────┘
  
值 = 邻居列中对应 Span 的索引
RC_NOT_CONNECTED (0x3f) = 无连接

访问宏:
  rcGetCon(s, dir)          获取方向 dir 的连接值
  rcSetCon(s, dir, val)     设置方向 dir 的连接值
  rcGetDirOffsetX(dir)      获取方向 dir 的 X 偏移 (-1/0/+1)
  rcGetDirOffsetY(dir)      获取方向 dir 的 Z 偏移 (-1/0/+1)
```

---

### 1.5 rcCompactHeightfield — 紧凑高度场

```cpp
struct rcCompactHeightfield {
    int width, height;           // XZ 网格尺寸
    int spanCount;               // 总 Span 数
    int walkableHeight;          // Agent 通行高度 (体素)
    int walkableClimb;           // Agent 攀爬高度 (体素)
    int borderSize;              // 边界大小
    unsigned short maxDistance;   // 最大距离值
    unsigned short maxRegions;   // 最大区域 ID
    float bmin[3], bmax[3];      // 包围盒
    float cs, ch;                // 体素尺寸
    rcCompactCell* cells;        // 列描述数组 [width * height]
    rcCompactSpan* spans;        // Span 数组 [spanCount]
    unsigned short* dist;        // 距离场 [spanCount]
    unsigned char* areas;        // 区域类型 [spanCount]
};
```

**访问模式**：
```cpp
// 遍历 (x, z) 列中的所有 Span
const rcCompactCell& c = chf.cells[x + z * chf.width];
for (int i = (int)c.index, ni = (int)(c.index + c.count); i < ni; ++i) {
    const rcCompactSpan& s = chf.spans[i];
    unsigned char area = chf.areas[i];
    unsigned short dist = chf.dist[i];
    // ...
}
```

**生命周期**：Step 4 创建 → Step 5~7 使用 → Step 7 后可释放

---

### 1.6 rcContour / rcContourSet — 轮廓

```cpp
struct rcContour {
    int* verts;              // 简化顶点 [(x,y,z,reg) * nverts]
    int nverts;
    int* rverts;             // 原始顶点 [(x,y,z,reg) * nrverts]
    int nrverts;
    unsigned short reg;      // 区域 ID
    unsigned char area;      // 区域类型
};

struct rcContourSet {
    rcContour* conts;        // 轮廓数组
    int nconts;              // 轮廓数量
    float bmin[3], bmax[3];  // 包围盒
    float cs, ch;            // 体素尺寸
    int width, height;       // 网格尺寸
    int borderSize;
    float maxError;          // 简化误差
};
```

---

### 1.7 rcPolyMesh — 多边形网格

```cpp
struct rcPolyMesh {
    unsigned short* verts;   // 顶点 [(x,y,z) * nverts]，体素坐标
    unsigned short* polys;   // 多边形 [maxpolys * 2 * nvp]
    unsigned short* regs;    // 区域 ID [maxpolys]
    unsigned short* flags;   // 标志位 [maxpolys]
    unsigned char* areas;    // 区域类型 [maxpolys]
    int nverts, npolys;
    int maxpolys, nvp;       // 最大多边形数, 每多边形最大顶点数
    float bmin[3], bmax[3];
    float cs, ch;
    int borderSize;
    float maxEdgeError;
};
```

```
polys 布局 (每个多边形 2*nvp 个 unsigned short):
┌───────────────────────┬───────────────────────┐
│ 顶点索引 (nvp 个)      │ 邻居索引 (nvp 个)      │
│ [v0, v1, v2, ..., 0xffff] │ [n0, n1, n2, ..., 0xffff] │
└───────────────────────┴───────────────────────┘
```

---

### 1.8 rcPolyMeshDetail — 细节网格

```cpp
struct rcPolyMeshDetail {
    unsigned int* meshes;    // 子网格描述 [4 * nmeshes]
    float* verts;            // 细节顶点 [3 * nverts]，世界坐标
    unsigned char* tris;     // 细节三角形 [4 * ntris]
    int nmeshes, nverts, ntris;
};
```

```
meshes[i*4]: [vertBase, vertCount, triBase, triCount]

tris[j*4]:  [vertA, vertB, vertC, edgeFlags]
  vertA/B/C: 局部顶点索引
    < polyVertCount → 引用 rcPolyMesh 的顶点
    ≥ polyVertCount → 引用 verts[vertBase + ...]
```

---

## 2. 运行时数据结构

### 2.1 dtNavMesh — Detour 导航网格

运行时核心数据结构，包含序列化后的导航数据。

### 2.2 dtNavMeshQuery — 导航查询

提供寻路 API：
- `findNearestPoly()` — 找最近多边形
- `findPath()` — A* 寻路
- `findStraightPath()` — 路径拉直
- `getPolyHeight()` — 查询高度

### 2.3 dtNavMeshCreateParams — 创建参数

```cpp
struct dtNavMeshCreateParams {
    // 多边形网格数据
    const unsigned short* verts;
    int vertCount;
    const unsigned short* polys;
    const unsigned short* polyFlags;
    const unsigned char* polyAreas;
    int polyCount;
    int nvp;
    
    // 细节网格数据 (可选)
    const unsigned int* detailMeshes;
    const float* detailVerts;
    int detailVertsCount;
    const unsigned char* detailTris;
    int detailTriCount;
    
    // Off-Mesh 连接 (可选)
    const float* offMeshConVerts;
    const float* offMeshConRad;
    const unsigned char* offMeshConDir;
    const unsigned char* offMeshConAreas;
    const unsigned short* offMeshConFlags;
    const unsigned int* offMeshConUserID;
    int offMeshConCount;
    
    // 通用参数
    float walkableHeight, walkableRadius, walkableClimb;
    float bmin[3], bmax[3];
    float cs, ch;
    bool buildBvTree;
};
```

---

## 3. 数据结构关系总图

```
rcHeightfield
  └── rcSpan (链表)
        ↓ rcBuildCompactHeightfield
rcCompactHeightfield
  ├── rcCompactCell (列索引)
  ├── rcCompactSpan (开放空间)
  ├── dist[] (距离场)
  └── areas[] (区域类型)
        ↓ rcBuildContours
rcContourSet
  └── rcContour (区域轮廓)
        ↓ rcBuildPolyMesh
rcPolyMesh (凸多边形网格)
        ↓ rcBuildPolyMeshDetail
rcPolyMeshDetail (高度细节)
        ↓ dtCreateNavMeshData
dtNavMesh (运行时导航数据)
  └── dtNavMeshQuery (寻路查询)
```

---

## 4. 常量速查

| 常量 | 值 | 含义 |
|------|-----|------|
| `RC_NULL_AREA` | 0 | 不可行走区域 |
| `RC_WALKABLE_AREA` | 63 | 默认可行走区域 |
| `RC_SPAN_HEIGHT_BITS` | 13 | Span 高度位数 |
| `RC_SPAN_MAX_HEIGHT` | 8191 | Span 最大高度 |
| `RC_SPANS_PER_POOL` | 2048 | 每个内存池的 Span 数 |
| `RC_NOT_CONNECTED` | 0x3f | 无连接标记 |
| `RC_BORDER_REG` | 0x8000 | 边界区域标记 |
| `RC_MESH_NULL_IDX` | 0xffff | 无效索引 |
| `DT_VERTS_PER_POLYGON` | 6 | Detour 最大多边形顶点数 |
| `DT_TILE_FREE_DATA` | 0x01 | 导航网格拥有数据所有权 |
