# Step 1：初始化构建配置 (rcConfig)

## 1. 概述

构建导航网格的第一步是将 GUI 中的用户参数转换为 `rcConfig` 结构体中的体素单位参数。
`rcConfig` 是整个构建流程的**配置中枢**，后续每一步都依赖其中的参数。

**关键代码位置**：`Sample_SoloMesh.cpp` 第 406~444 行

---

## 2. rcConfig 参数详解

### 2.1 分辨率参数

| 参数 | 类型 | 单位 | 说明 |
|------|------|------|------|
| `cs` (cellSize) | float | 世界单位(wu) | XZ 平面每个体素格子的边长 |
| `ch` (cellHeight) | float | 世界单位(wu) | Y 轴每个体素的高度 |
| `width` | int | 体素(vx) | 高度场 X 轴网格数（自动计算） |
| `height` | int | 体素(vx) | 高度场 Z 轴网格数（自动计算） |

### 2.2 Agent 参数

| 参数 | GUI 来源 | 转换公式 | 取整方式 | 原因 |
|------|---------|----------|----------|------|
| `walkableHeight` | agentHeight | `ceil(agentHeight / ch)` | **向上取整** | 保守估计，确保 Agent 能站得下 |
| `walkableClimb` | agentMaxClimb | `floor(agentMaxClimb / ch)` | **向下取整** | 保守估计，避免攀爬过高 |
| `walkableRadius` | agentRadius | `ceil(agentRadius / cs)` | **向上取整** | 保守估计，确保 Agent 不穿墙 |
| `walkableSlopeAngle` | agentMaxSlope | 直接使用（度） | 不取整 | 浮点比较 |

### 2.3 网格生成参数

| 参数 | GUI 来源 | 转换公式 | 影响步骤 |
|------|---------|----------|---------|
| `maxEdgeLen` | edgeMaxLen | `(int)(edgeMaxLen / cs)` | Step 5 轮廓简化 |
| `maxSimplificationError` | edgeMaxError | 直接使用(wu) | Step 5 轮廓简化 |
| `minRegionArea` | regionMinSize | `(int)rcSqr(regionMinSize)` | Step 4 区域过滤 |
| `mergeRegionArea` | regionMergeSize | `(int)rcSqr(regionMergeSize)` | Step 4 区域合并 |
| `maxVertsPerPoly` | vertsPerPoly | 直接使用 | Step 6 多边形合并 |
| `detailSampleDist` | detailSampleDist | `cs * detailSampleDist`（<0.9 则为 0） | Step 7 细节采样 |
| `detailSampleMaxError` | detailSampleMaxError | `ch * detailSampleMaxError` | Step 7 细节采样 |

---

## 3. 单位转换公式

### 3.1 世界坐标 → 体素坐标

```
voxelX = (worldX - bmin[0]) / cs
voxelY = (worldY - bmin[1]) / ch
voxelZ = (worldZ - bmin[2]) / cs
```

### 3.2 体素坐标 → 世界坐标

```
worldX = bmin[0] + voxelX * cs
worldY = bmin[1] + voxelY * ch
worldZ = bmin[2] + voxelZ * cs
```

### 3.3 网格尺寸计算

```cpp
// rcCalcGridSize 内部实现
width  = (int)((bmax[0] - bmin[0]) / cs + 0.5f);  // X 方向体素数
height = (int)((bmax[2] - bmin[2]) / cs + 0.5f);  // Z 方向体素数
```

---

## 4. 取整策略的设计哲学

Recast 在参数转换时采用**保守估计**策略：

```
   实际世界                    体素世界
 ┌────────┐                ┌────────┐
 │        │                │        │
 │ Agent  │ 身高 1.8m      │ Agent  │ walkableHeight = ceil(1.8/0.2) = 9 体素
 │ Height │ ch = 0.2m      │ Height │ 实际代表 9*0.2 = 1.8m ✓ 精确
 │        │                │        │
 └────────┘                └────────┘

 │ Agent  │ 身高 1.7m      │ Agent  │ walkableHeight = ceil(1.7/0.2) = 9 体素
 │ Height │ ch = 0.2m      │ Height │ 实际代表 9*0.2 = 1.8m > 1.7m → 保守偏大

 │ Agent  │ 攀爬 0.5m      │ Agent  │ walkableClimb = floor(0.5/0.2) = 2 体素
 │ Climb  │ ch = 0.2m      │ Climb  │ 实际代表 2*0.2 = 0.4m < 0.5m → 保守偏小
```

**总结**：
- **身高/半径**向上取整 → 要求更多空间 → Agent 不会卡住
- **攀爬高度**向下取整 → 允许更少攀爬 → Agent 不会尝试不安全的攀爬

---

## 5. 区域面积参数的含义

`minRegionArea` 和 `mergeRegionArea` 使用 `rcSqr()` 是因为参数语义是"边长"：

```cpp
m_cfg.minRegionArea = (int)rcSqr(m_regionMinSize);    // 8² = 64 体素²
m_cfg.mergeRegionArea = (int)rcSqr(m_regionMergeSize); // 20² = 400 体素²
```

这意味着：
- 面积小于 64 体素²（约 8×8）的独立区域将被**移除**
- 面积小于 400 体素²（约 20×20）的相邻区域将被**合并**到更大区域中

---

## 6. 包围盒设置

```cpp
rcVcopy(m_cfg.bmin, bmin);  // 从输入几何体获取包围盒
rcVcopy(m_cfg.bmax, bmax);
rcCalcGridSize(m_cfg.bmin, m_cfg.bmax, m_cfg.cs, &m_cfg.width, &m_cfg.height);
```

包围盒定义了导航网格的**构建范围**：
- 包围盒外的三角形将被忽略（不参与光栅化）
- Solo 模式下通常使用输入网格的完整包围盒
- Tile 模式下每个 Tile 有自己的子包围盒

---

## 7. 典型参数值参考

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| cs | 0.3 | 室内 0.1~0.2，室外 0.3~0.5 |
| ch | 0.2 | 通常 ≤ cs |
| agentHeight | 2.0 | 人形角色约 2m |
| agentRadius | 0.6 | 人形角色约 0.6m |
| agentMaxClimb | 0.9 | 楼梯台阶约 0.3~0.5m |
| agentMaxSlope | 45.0 | 45° 以上视为不可行走 |
| regionMinSize | 8 | 面积 < 64 的区域被移除 |
| regionMergeSize | 20 | 面积 < 400 的区域被合并 |
| maxVertsPerPoly | 6 | Detour 最大支持 6 |
